# Data transformation
---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Data transformation
```{r}
if(!require(plyr)) install.packages("plyr")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tibble)) install.packages("tibble")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(forcats)) install.packages("forcats")
if(!require(patchwork)) install.packages("patchwork")
if(!require(scales)) install.packages("scales")
if(!require(readr)) install.packages("readr")
if(!require(ggthemes)) install.packages("ggthemes")
if(!require(ggrepel)) install.packages("ggrepel")
if(!require(GGally)) install.packages("GGally")
if(!require(plotly)) install.packages("plotly")
if(!require(forcats)) install.packages("forcats")
if(!require(stringr)) install.packages("stringr")

if(!require(ggpubr)) install.packages("ggpubr")
if(!require(PupillometryR)) install.packages("PupillometryR")
if(!require(ggridges)) install.packages("ggridges")
if(!require(RColorBrewer)) install.packages("RColorBrewer")
if(!require(magrittr)) install.packages("magrittr") # allow %<>%

if(!require(vcd)) install.packages("vcd")
if(!require(d3r)) install.packages("d3r")
if(!require(ggalluvial)) install.packages("ggalluvial")
if(!require(parcoords)) install.packages("parcoords")
if(!require(openxlsx)) install.packages("openxlsx")
# pair plot
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(gridGraphics)) install.packages("gridGraphics")
if(!require(gridExtra)) install.packages("gridExtra")

library("data.table")

theme(plot.title = element_text(hjust=0.5))  -> center_title
```


```{r}
library("data.table")


writeEXCEL <- function(df, file = filename, fgFill = "#007b58") {
  options("openxlsx.borderColour" = fgFill)
  hs <- createStyle(
    textDecoration = "BOLD",
    fontColour = "#FFFFFF",
    fontSize = 12.5,
    fontName = "Microsoft YaHei",
    #border = c("left", "right"),
    fgFill = fgFill,
    halign = "center",
    valign = "center",
    wrapText = T
  )
  
  write.xlsx(
    df,
    file = file,
    #borders = 'all',
    firstRow = TRUE,
    asTable = TRUE,
    withFilter = TRUE,
    colWidths = 50, 
    headerStyle = hs
  )
}

```




```{r}
fread("data/BusinessAnalyst.csv") %>% select(-c(V1, index)) -> df_ba
fread("data/DataAnalyst.csv")  -> df_da
fread("data/DataEngineer.csv") -> df_de
fread("data/DataScientist.csv") %>% select(-c(V1, index)) -> df_ds
```

```{r}
inner_join(
  df_ds %>% transmute(`Job Title`, `Job Description`, `Company Name`, datafile = "DS"),
  df_da %>% transmute(`Job Title`, `Job Description`, `Company Name`, datafile = "DA"),
  by = "Job Description"
) %>% unique %>%
  arrange_at("Job Title.x")
  

  
```
 
## Get new job title using speical character in title and description
```{r}
bind_rows(
  df_ba,
  df_da,
  df_de,
  df_ds
) %>% 
  distinct(`Job Title`, `Job Description`, `Company Name`) %>%
  mutate(is_de_byjd = ifelse(grepl("Data Engineer|Big Data|data engineer|Data engineer|data Engineer", `Job Description`), 1, 0)) %>%
  mutate(is_de_byjt = ifelse(grepl("Data Engineer|DE|Big Data", `Job Title`, ignore.case = T), 1, 0)) %>%
  
  mutate(is_da_byjd = ifelse(grepl("Data Analyst|Data Analysis|Data analyst|data analyst", `Job Description`), 1, 0)) %>%
  mutate(is_da_byjt = ifelse(grepl("Data Analyst|Data Analysis|DA", `Job Title`, ignore.case = T), 1, 0)) %>%

  mutate(is_ds_byjd = ifelse(grepl("Data Scientist|data scientist|Data scientist||data Scientist|Data Science|data science|Data science|NLP|Machine Learning|machine learning|Machine learning", `Job Description`,), 1, 0)) %>%
  mutate(is_ds_byjt = ifelse(grepl("Data Scientist|Data Science|DS|NLP|Machine Learning|ML", `Job Title`, ignore.case = T), 1, 0)) %>%
  
  mutate(is_ba_byjd = ifelse(grepl("Business Analyst|business analyst|Business analyst|Business Analytics|business analytics|Business analytics", `Job Description`), 1, 0)) %>%
  mutate(is_ba_byjt = ifelse(grepl("Business Analyst|Business|BA|Business Analytics", `Job Title`, ignore.case = T), 1, 0)) %>%
  
  mutate(is_others = ifelse(is_de_byjd + is_de_byjt + is_da_byjd + is_da_byjt + is_ba_byjt + is_ba_byjd + is_ds_byjt + is_ds_byjd== 0, 1, 0)) -> df_labeled   
  
df_labeled %>%
  pivot_longer(4:ncol(.)) %>% 
  filter(value!=0) %>%
  group_by(name) %>%
  summarise(n = n()) %>%
  arrange(-n) %>%
  pull(name)  #give sequence 

df_labeled %>%
  mutate(job_type = case_when(
    is_ds_byjt == 1 ~ "DS",
    is_de_byjt == 1 ~ "DE",
    is_ba_byjt == 1 ~ "BA",
    is_da_byjt == 1 ~ "DA",
    
    is_ds_byjd == 1 ~ "DS",
    is_de_byjd == 1 ~ "DE",
    is_ba_byjd == 1 ~ "BS",
    is_da_byjd == 1 ~ "DA"

  )) %>% #Job title is more accurate than JD
  select(`Job Title`, `Job Description`, `Company Name`, job_type) -> unique_mapper
```

## plot distribution of four new lableed Job title
```{r}
# one to one
unique_mapper %>%
ggplot() +
  aes(x =  job_type) +
  geom_histogram(stat="count") +
  labs(title = 'Count of four new job label', x = "Job title") +
  center_title
```


```{r}
# one to many label
df_labeled %>%
  rowwise() %>%
  mutate(is_ba = max(is_ba_byjt, is_ba_byjd)) %>%
  mutate(is_de = max(is_de_byjt, is_de_byjd)) %>%
  mutate(is_ds = max(is_ds_byjt, is_ds_byjd)) %>%
  mutate(is_da = max(is_da_byjt, is_da_byjd)) %>%
  select(1:3, is_ba, is_de, is_da, is_ds) %>%
  pivot_longer(4:ncol(.), 
               names_to = "Job_Type") %>% 
  filter(value!=0) %>% select(-value) -> multi_mapper

multi_mapper %>%  
ggplot() +
  aes(x =  Job_Type) +
  geom_histogram(stat="count")
```
 
## get data with updated job title
```{r}
bind_rows(
  df_ba %>% mutate(file_Type = "BA"),
  df_da %>% mutate(file_Type = "DA"),
  df_de %>% mutate(file_Type = "DE"),
  df_ds %>% mutate(file_Type = "DS")
) %>%
  unique %>%
  left_join(unique_mapper)  -> clean_jobT  

```


## find all missing value, replaced with NA, clean company name, seperate salary estimate into min, max and avg of salary
```{r}
clean_jobT %>%
  select(1:ncol(.))%>%
  mutate_all(~ifelse(. %in% c("NA", -1, "Unknown", "Unknown / Non-Applicable"), NA, .))   %>%
  mutate_at('Job Title',~ifelse(. %in% c("Sr. Data Analyst","Sr Data Analyst","Sr Analyst,Dara","(Senior) Data Engineer" ), "Senior Data Analyst", .)) %>%
  mutate_at('Job Title' ,~ifelse(. %in% c("Jr. Data Analyst","Jr Data Analyst","Data Analyst Junior"), "Junior Data Analyst", .)) %>%
  #mutate_at('Job Title',~str_replace_all(., "+", ""))  %>%
  as_tibble %>%
  separate(`Company Name`, into = c("Name of Company","rate"), sep = "\n",remove = T) %>% 
  select(-rate)%>% 
  separate(`Salary Estimate`, into = c("low","high"), sep = "-",remove = T) %>%
  mutate(low_salary = as.numeric(str_extract(low, "\\d+")),
         high_salary = as.numeric(str_extract(high, "\\d+")),
         avg_salary = (low_salary + high_salary) / 2)  %>% 
  rename("Low_salary(k)" = low_salary,
        "High_salary(k)" = high_salary, 
        "Avg_salary(k)" = avg_salary) %>%  
  select(c(-low,-high))-> clean_data  

```

## take out state from location column
```{r}

fread("data/state.csv") -> state_df

clean_data %>% 
  mutate(State = str_sub(`Location`,-2))  %>% 
  right_join(state_df)   %>% 
  relocate(State, .before = `Location`)  -> clean_loc  

split(clean_data, ~job_type) ->  clean_locs 


```

##prepare data for D3
```{r}
clean_loc %>% 
  mutate(State = str_sub(`Location`,-2))  %>% 
  right_join(state_df)   %>% 
  relocate(State, .before = `Location`)  %>% 
  group_by(State,job_type) %>% 
  mutate(n = n(),
            salary_state_avg = mean(`Avg_salary(k)`, na.rm=T))%>% 
  arrange(-salary_state_avg) -> state_salary
```

## save as xlsx file
```{r}
# clean_loc %>%
#   writeEXCEL("clean_loc.xlsx") 
#   
# state_salary %>%
#   writeEXCEL("state_salary_new.xlsx")
```




