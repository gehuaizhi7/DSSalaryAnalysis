<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v6.js"></script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div id="viz_map">
        <input type="checkbox" class="checkbox" value="DA" checked><label>Data Analytics</label>
        <input type="checkbox" class="checkbox" value="DS" checked><label>Data Scientist</label>
        <input type="checkbox" class="checkbox" value="BA" checked><label>Business Analytics</label>
        <input type="checkbox" class="checkbox" value="DE" checked><label>Data Engineer</label>
    </div>

    <title>EDAV-D3</title>
</head>
<body>
</body>
</html>

<script>
    

    // set width and height of svg
    const width = 800
    const height = 400

    // The svg
    const svg = d3.select("#viz_map")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        


    
    // Map and projection
    const projection = d3.geoMercator()
        .center([-95, 40])                // GPS of location to zoom on
        .scale(600)                       // This is like the zoom
        .translate([ width/2, height/2 ])
    
    // Create data for circles:
    const markers = [
        {long: -74.01, lat: 40.71, group: "DA", size: 34, name: "New York", count: 100}, // new york city
        {long: -122.42, lat: 37.77, group: "BA", size: 14, name: "New York", count: 80}, // San Francisco
        {long: -122.42, lat: 37.77, group: "DS", size: 100, name: "New York", count: 20}, // San Francisco
        {long: -100.42, lat: 39.77, group: "DE", size: 60, name: "New York", count: 30}, // San Francisco
    ];

    // Load external data and boot
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then( function(data){
    
        // Filter data
        data.features = data.features.filter(d => {console.log(d.properties.name); return d.properties.name=="USA"})
    
        // Create a color scale
        const color = d3.scaleOrdinal()
            .domain(["DA", "DS", "BA", "DE"])
            .range([ "#d17575", "#7580d1", "#75d180", "#d1c275"])

        // Add a scale for bubble size
        const size = d3.scaleLinear()
            .domain([1,100])  // What's in the data
            .range([ 4, 50])  // Size in pixel

        // Draw the map
        svg.append("g")
            .selectAll("path")
            .data(data.features)
            .join("path")
              .attr("fill", "lightgrey")
              .attr("d", d3.geoPath()
                  .projection(projection)
              )
            .style("stroke", "grey")

        // create a tooltip
        const Tooltip = d3.select("#viz_map")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px")


        // Three function that change the tooltip when user hover / move / leave a cell
        const mouseover = function(event, d) {
        Tooltip.style("opacity", 1)

        }
        var mousemove = function(event, d) {
            Tooltip
                .html(d.name + "<br>" + "count: " + d.count + "<br>" + "average salary: " + d.size)
                .style("left", (event.x)/2 + "px")
                .style("top", (event.y)/2 - 30 + "px")
        }
        var mouseleave = function(event, d) {
        Tooltip.style("opacity", 0)
        }



        // Add circles:
        svg
            .selectAll("myCircles")
            .data(markers)
            .join("circle")
                .attr("class" , d => d.group )
                .attr("cx", d => projection([d.long, d.lat])[0])
                .attr("cy", d => projection([d.long, d.lat])[1])
                .attr("r", d => size(d.size))
                .style("fill", d => color(d.group))
                .attr("stroke", d => color(d.group))
                .attr("stroke-width", 3)
                .attr("fill-opacity", .4)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
        


        // This function is gonna change the opacity and size of selected and unselected circles
        function update(){

            // For each check box:
            d3.selectAll(".checkbox").each(function(d){
                cb = d3.select(this);
                grp = cb.property("value")

                // If the box is check, I show the group
                if(cb.property("checked")){
                    svg.selectAll("."+grp).transition().duration(1000).style("opacity", 1).attr("r", function(d){ return size(d.size) })

                // Otherwise I hide it
                }else{
                    svg.selectAll("."+grp).transition().duration(1000).style("opacity", 0).attr("r", 0)
                }
            })
        }

        // When a button change, I run the update function
        d3.selectAll(".checkbox").on("change",update);

        // And I initialize it at the beginning
        update()
    })
    </script>