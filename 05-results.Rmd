# Results

```{r include=FALSE}
# Basics
if(!require(dplyr)) install.packages("dplyr")
if(!require(tibble)) install.packages("tibble")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(forcats)) install.packages("forcats")
if(!require(patchwork)) install.packages("patchwork")
if(!require(scales)) install.packages("scales")
if(!require(readr)) install.packages("readr")
if(!require(ggthemes)) install.packages("ggthemes")
if(!require(ggrepel)) install.packages("ggrepel")
if(!require(GGally)) install.packages("GGally")
if(!require(plotly)) install.packages("plotly")
if(!require(forcats)) install.packages("forcats")
if(!require(stringr)) install.packages("stringr")

if(!require(ggpubr)) install.packages("ggpubr")
if(!require(PupillometryR)) install.packages("PupillometryR")
if(!require(ggridges)) install.packages("ggridges")
if(!require(RColorBrewer)) install.packages("RColorBrewer")
if(!require(magrittr)) install.packages("magrittr") # allow %<>%

if(!require(vcd)) install.packages("vcd")
if(!require(d3r)) install.packages("d3r")
if(!require(ggalluvial)) install.packages("ggalluvial")
if(!require(parcoords)) install.packages("parcoords")

# pair plot
if(!require(gridGraphics)) install.packages("gridGraphics")
if(!require(gridExtra)) install.packages("gridExtra")

library("data.table")
library(mi)
theme(plot.title = element_text(hjust=0.5))  -> center_title
```

```{r include=FALSE}
if(!require(stopwords)) install.packages("stopwords")
library("stopwords")
library(tidyverse)
library(tidytext)
library("wordcloud")
library("wordcloud2")
library(textstem)
library(rmarkdown)

median_ybh <- function(x) median(x,na.rm=T)
mean_ybh <- function(x) mean(x,na.rm = T)
```

```{r echo=FALSE}
# Loading
library("readxl")
data <- read_excel("data/clean_loc.xlsx")
split(data, data$job_type) -> datas
```



```{r echo=FALSE}
# turn into lower case
data%>% 
  mutate(lower_jd = tolower(`Job Description`)) -> data
         
c("python", "sql", "hadoop", "mysql", "tensorflow", "numpy","pandas","machine[[:space:]]learning","excel","tensorflow",
"keras","pytorch","[[:space:]]ai[[:space:]]","data[[:space:]]visualization","business[[:space:]]strategy","database","spark","git","[[:space:]]c[[:space:]]","matlab","matplotlib","scipy","opencv","anaconda","spacy","nlp","java","[[:space:]]golang[[:space:]]","github","kaggle","tableau","java[[:space:]]script","[[:space:]]r[[:space:]]" ) ->tech_requires

for(tech_require in tech_requires){
  new_column_name = paste0("require_", tech_require)
  data %<>%
    mutate(!!sym(new_column_name) := ifelse(grepl(tech_require, 
                                                  `lower_jd`, 
                                                  ignore.case = T), 1, 0)) 
}
# " r " %in% 


c('scikit-learn','sklearn',"scikit[[:space:]]learn") -> tech_requires3

for(tech_require in tech_requires3){
  new_column_name = paste0("require_", tech_require)
  data %<>%
    mutate(!!sym(new_column_name) := ifelse(grepl(tech_require, 
                                                  `lower_jd`), 1, 0)) 
}

data %>% 
  rowwise()  %>% 
  mutate(require_scikit_learn = max(`require_scikit-learn`,
                               `require_sklearn`,
                               `require_scikit[[:space:]]learn`,
                               na.rm=T)) %>%
  ungroup()%>%
  select(-`require_scikit-learn`,
         -`require_sklearn`,
         -`require_scikit[[:space:]]learn`)-> data_2 


data_2 %>%
  select(`Avg_salary(k)`, contains("require_")) %>%
  pivot_longer(2:ncol(.),
               names_to = "Tech") %>% 
  mutate(Tech = gsub("require_", "", Tech)) %>%
  mutate(Tech = gsub("[[:space:]]+", " ", Tech)) %>%
  mutate(Tech = gsub("\\[\\[\\:space\\:\\]\\]", " ", Tech)) %>%
  filter(value !=0) -> skill_data

skill_data %>%
  group_by(Tech)%>%
  summarise(freq=n())%>%
  arrange(-freq)-> skill_count  

median_ybh <- function(x) median(x,na.rm=T)

```
## wordcloud for skillset
```{r echo=FALSE, fig,width = 3, fig.height = 3}
skill_count %>% 
  arrange(-freq)%>% 
  ungroup() %>% 
  as.data.frame() -> df_word

rownames(df_word) <- df_word$Tech
wordcloud2(df_word , size = 2, shape = 'data') 
```


### Box plot for skillset vs salary
```{r echo=FALSE, fig.width=8.5}
skill_data %>%
  mutate(rank = fct_reorder(Tech, 
                            `Avg_salary(k)`, 
                            median_ybh))%>%
  ggplot(aes(x = rank,
      y = `Avg_salary(k)`))+
  geom_boxplot(show.legend = F) +
  theme(axis.text.x = element_text(hjust=0.85, angle=30)) +
  labs(title = "Skill set vs salary") +
  labs(x = "Skill set") +
  labs(y = "Average salary in k")+ 
  center_title 

```


## salary vs job title 
```{r echo=FALSE, fig.width=8.5}
data %>%
  drop_na(job_type)   %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0))  %>% 
  ggplot(aes(y=`Avg_salary(k)`, 
             x = job_type)) +
  geom_boxplot(show.legend = F) +
  labs(title = 'Average salary for job titles') + 
  labs(x = "Job titile") +
  labs(y = 'Average salary in unit k') +
  center_title
```


## Education level vs salary
```{r echo=FALSE}
data%>% 
  mutate(lower_jd = tolower(`Job Description`))%>% 
  select("Job Title","lower_jd","Sector","Low_salary(k)","High_salary(k)","Avg_salary(k)") -> data_lower

c("bacherlor" ,"undergraduate","undergrad","undergraduate[[:space:]]student") -> undergrads
c("master","grad","graduate[[:space:]]student") -> grads
c("phd","doctorate","doctor")  -> phds

for(undergrad in undergrads){
  new_column_name = paste0("require_", undergrad)
  data_lower %<>%
    mutate(!!sym(new_column_name) := ifelse(grepl(undergrad, 
                                                `lower_jd`), 1, 0))
}

for(grad in grads){
  new_column_name = paste0("require_", grad)
  data_lower %<>%
    mutate(!!sym(new_column_name) := ifelse(grepl(grad, 
                                                  `lower_jd`), 1, 0))
}

for(phd in phds){
  new_column_name = paste0("require_", phd)
  data_lower %<>%
    mutate(!!sym(new_column_name) := ifelse(grepl(phd, 
                                                  `lower_jd`), 1, 0))
}


data_lower %>%  
  rowwise()  %>% 
  mutate(require_Phd = max(`require_phd`,`require_doctorate`,`require_doctor`,
                               na.rm=T)) %>% 
  mutate(require_Master = max(`require_master`,
                               `require_grad`,
                               `require_graduate[[:space:]]student`,
                               na.rm=T)) %>%
  mutate(require_Bacherlor = max(`require_bacherlor`,
                               `require_undergraduate`,
                               `require_undergrad`,
                               `require_undergraduate[[:space:]]student`,
                               na.rm=T)) %>% 
  ungroup() %>% 
  select(-`require_phd`,-`require_doctorate`,-`require_doctor`) %>%
  select(-`require_master`, 
         -`require_grad`, 
         -`require_graduate[[:space:]]student`) %>%
  select(-`require_bacherlor`,
         -`require_undergraduate`,
         -`require_undergrad`,
         -`require_undergraduate[[:space:]]student`)-> data_academic   

data_academic%>% 
  select(`Avg_salary(k)`, contains("require_")) %>%
  pivot_longer(2:ncol(.),
               names_to = "Academic")%>% 
  mutate(Academic = gsub("require_", "", Academic)) %>%
  mutate(Academic = gsub("[[:space:]]+", " ", Academic)) %>%
  mutate(Academic = gsub("\\[\\[\\:space\\:\\]\\]", " ", Academic)) %>%
  filter(value !=0) -> data_academics 


median_ybh <- function(x) median(x,na.rm=T)
```

```{r echo=FALSE, fig.width=8.5}
data_academics %>% 
  mutate(ranking = fct_reorder(Academic, 
                            `Avg_salary(k)`, 
                            median_ybh))%>%
  ggplot(aes(x = ranking,
      y = `Avg_salary(k)`))+
  geom_boxplot(show.legend = F) +
  labs(title = "Education vs salary") +
  labs(x = "Education") +
  labs(y = "Average salary in unit k") + 
  center_title 

```


## Ridge line plot for sector vs salary
```{r echo=FALSE,message=FALSE, warning=FALSE}
data%>% 
  drop_na(Sector)%>% 
  group_by(Sector)%>% 
  summarise(n = n()) %>%
  arrange(-n) %>%
  mutate(sector_label = ifelse(min_rank(-n) <=30, Sector, "Others") %>%
  factor %>% fct_relevel("Others", after=Inf)) -> sector_to_label_map

data %>%
  right_join(sector_to_label_map) -> sector_data
```

```{r echo=FALSE, fig.width=8.5,fig.height=9}
sector_data%>% 
  ggplot(aes(y=fct_reorder(sector_label, `Avg_salary(k)`,median_ybh) %>%
               fct_relevel("Others", after=Inf),
             x=`Avg_salary(k)`, fill = sector_label)) + 
  geom_density_ridges(alpha=0.6)  + 
  labs(title = 'Sector vs salary') + 
  labs(y = "Salary") +
  labs(x = 'Sector') +
  theme_ridges() + 
  theme(legend.position = "none") +
  theme(axis.title.y = element_text(angle=0, vjust = 0.5)) +
  theme(axis.title.x = element_text(angle=0, hjust = 0.5)) +
  center_title 
```

## Hex plot for founded year vs salary hex plot
```{r echo=FALSE, fig.width=8.5}

data%>% 
  drop_na(Founded)%>% 
  ggplot(aes(x=`Founded`,
             y=`Avg_salary(k)`)) +
  facet_wrap(~job_type) + 
  geom_hex(bins = 50) +
  scale_fill_gradient(low = "#DEEBF7", high = "#08519C") + 
  labs(title = 'Company founded year vs salary') + 
  labs(y = "Salary") +
  labs(x = 'Company founded year') +
  theme_classic() +
  center_title

```

## Cleveland dot plot for Company vs salary
```{r echo=FALSE}
data %>% 
  group_by(`Name of Company`) %>%
  summarise(n= n()) %>%
  mutate(company_label = ifelse(min_rank(-n) <=20, `Name of Company`, "Others") %>%
  factor %>% fct_relevel("Others", after=Inf)) -> company_to_label_map

data %>%
  left_join(company_to_label_map) -> company_data

company_data%>%  
  drop_na(`job_type`)%>% 
  group_by(`job_type`,company_label)%>% 
  mutate(salary_jobT= mean_ybh(`Avg_salary(k)`)) %>% 
  arrange(-salary_jobT) %>% 
  select(company_label,`job_type`,salary_jobT)%>%
  filter(company_label != "Others") -> data_company

```

```{r echo=FALSE, fig.width=8.5, fig.height = 7}
data_company%>%
  ggplot(aes(x=salary_jobT,
            y=fct_reorder(company_label, salary_jobT,median_ybh),
            color = `job_type`))+
  geom_point(size = 2)  + 
  labs(title = 'Company vs salary') + 
  labs(y = "Company") +
  labs(x = 'Salary') +
  theme_linedraw() +
  center_title
  
```

## Glassdoor rating vs salary, wrap by Industry
```{r echo=FALSE, fig.height=7, fig.width=9}

cor_df <- data %>%
  drop_na(Rating)%>% 
  drop_na(Sector)%>% 
  drop_na(job_type)%>% 
  group_by(Sector) %>%
  summarize(cor = cor(Rating, `Avg_salary(k)`), beta = lm(`Avg_salary(k)`~Rating)$coefficients[2], meanprice = mean(`Avg_salary(k)`)) %>%
  ungroup() %>%
  arrange(beta) 

data %>%
  ggplot(aes(x=`Rating`,
             y=`Avg_salary(k)`,color = `job_type`)) +
  geom_line(stat="smooth",method = "lm", 
              size = 0.8,
              alpha = 0.5) + 
  geom_point(size = .7,alpha = 0.2) +
  facet_wrap(~fct_relevel(Sector, as.character(cor_df$Sector))) +
  xlab('Rating') +
  ylab("Average salary") +
  labs(title = 'Rating vs salary wrap up by industry ') +
  theme_linedraw() + 
  center_title
  
  
```


## Alluvial plot (Sector, Type of ownership, salary_group) 
```{r,echo=FALSE, fig.width=23, fig.height=15}
data %>% 
  drop_na(`Type of ownership`) %>% 
  drop_na(Sector) %>% 
  drop_na(`Avg_salary(k)`) ->data2

data2 %>% 
  mutate(salary_group = if_else(`Avg_salary(k)`>100,"high",
                            if_else(`Avg_salary(k)`<70,"low","medium"))) %>% 
  mutate(salary_group = factor(salary_group,levels = c("high","medium","low")))->data2

data2 %>% 
  group_by(Sector,`Type of ownership`,salary_group) %>% 
  summarize(n = n()) %>% 
  filter(n>100) %>% 
  ggplot(aes(axis1 = Sector, axis2 = `Type of ownership`, axis3 = salary_group, y = n)) +
  geom_alluvium(aes(fill = salary_group),color = "black") +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum), "\n", after_stat(count))),size=5) +
  scale_x_discrete(limits = c("Sector", "Type of ownership", "salary_group")) 

```

## Employee Salary Group VS Company Revenue Level - Mosaic Plot
```{r echo=FALSE}

data %>%
  drop_na(Revenue)  %>% 

  mutate(revenue_level = case_when(
      Revenue =="$10+ billion (USD)" ~ "10b+",
      Revenue =="$5 to $10 billion (USD)" ~ "10b",
      Revenue =="$2 to $5 billion (USD)" ~ "5b",
      Revenue =="$1 to $2 billion (USD)" ~ "2b",
      Revenue =="$500 million to $1 billion (USD)" ~ "1b",
      Revenue =="$100 to $500 million (USD)" ~ "0.5b",
      Revenue =="$50 to $100 million (USD)" ~ "100m",
      Revenue =="$25 to $50 million (USD)" ~ "50m",
      Revenue =="$10 to $25 million (USD)" ~ "25m",
      Revenue =="$5 to $10 million (USD)" ~ "10m",
      Revenue =="$1 to $5 million (USD)" ~ "5m",
      Revenue =="Less than $1 million (USD)" ~ "1m"
    )) -> data_revenue

```

```{r echo=FALSE}
data_revenue %>% 
  drop_na(`Avg_salary(k)`) %>%
  mutate(salary_group = if_else(`Avg_salary(k)`>100,"High(>100k)",
                            if_else(`Avg_salary(k)`<80,"low(<90K)","medium(80~100K)"))) -> data_revenue_salary
```


```{r echo=FALSE, fig.width=10, fig.height = 6}
data_revenue_salary %>% 
  mutate(revenue_level = factor(revenue_level,levels = 
                                 c("1m",
                                   "5m",
                                   "10m",
                                   "25m",
                                   "50m",
                                   "100m",
                                   "0.5b",
                                   "1b",
                                   "2b",
                                   "5b",
                                   "10b",
                                   "10b+"
                                   ))) %>% 
  mutate(salary_group = factor(salary_group,levels = c("High(>100k)","medium(80~100K)","low(<90K)"))) %>% 
  vcd::mosaic(salary_group~revenue_level, .,
              shade = TRUE,
              direction = c("v","h"),
              highlighting_fill = RColorBrewer::brewer.pal(3, "Blues"),
              spacing = vcd::spacing_dimequal(c(.3, 0, 0)),
              main = "Employee Salary Group v.s. Company Revenue Level")


```
